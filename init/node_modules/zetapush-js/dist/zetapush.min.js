!function(e,t){"object"==typeof exports&&"undefined"!=typeof module?t(exports):"function"==typeof define&&define.amd?define(["exports"],t):t(e.ZetaPush={})}(this,function(e){"use strict";var t=function(e,t){if(!(e instanceof t))throw new TypeError("Cannot call a class as a function")},n=function(){function e(e,t){for(var n=0;t.length>n;n++){var r=t[n];r.enumerable=r.enumerable||!1,r.configurable=!0,"value"in r&&(r.writable=!0),Object.defineProperty(e,r.key,r)}}return function(t,n,r){return n&&e(t.prototype,n),r&&e(t,r),t}}(),r=function(e,t,n){return t in e?Object.defineProperty(e,t,{value:n,enumerable:!0,configurable:!0,writable:!0}):e[t]=n,e},i=function e(t,n,r){null===t&&(t=Function.prototype);var i=Object.getOwnPropertyDescriptor(t,n);if(void 0===i){var o=Object.getPrototypeOf(t);return null===o?void 0:e(o,n,r)}if("value"in i)return i.value;var s=i.get;return void 0!==s?s.call(r):void 0},o=function(e,t){if("function"!=typeof t&&null!==t)throw new TypeError("Super expression must either be null or a function, not "+typeof t);e.prototype=Object.create(t&&t.prototype,{constructor:{value:e,enumerable:!1,writable:!0,configurable:!0}}),t&&(Object.setPrototypeOf?Object.setPrototypeOf(e,t):e.__proto__=t)},s=function(e,t){if(!e)throw new ReferenceError("this hasn't been initialised - super() hasn't been called");return!t||"object"!=typeof t&&"function"!=typeof t?e:t},u=function e(n){var r=n.$publish;t(this,e),this.$publish=r},a=function(e){function r(){return t(this,r),s(this,(r.__proto__||Object.getPrototypeOf(r)).apply(this,arguments))}return o(r,u),n(r,null,[{key:"DEFAULT_DEPLOYMENT_ID",get:function(){return"delegating_0"}}]),r}(),c=function(e){function r(){return t(this,r),s(this,(r.__proto__||Object.getPrototypeOf(r)).apply(this,arguments))}return o(r,u),n(r,null,[{key:"DEFAULT_DEPLOYMENT_ID",get:function(){return"simple_0"}}]),r}(),l=function(e){function r(){return t(this,r),s(this,(r.__proto__||Object.getPrototypeOf(r)).apply(this,arguments))}return o(r,u),n(r,[{key:"control",value:function(e){return this.$publish("control",{publicToken:e.publicToken,fullRights:e.fullRights})}},{key:"getToken",value:function(){return this.$publish("getToken",{})}},{key:"release",value:function(e){return this.$publish("release",{publicToken:e.publicToken,fullRights:e.fullRights})}}],[{key:"DEFAULT_DEPLOYMENT_ID",get:function(){return"weak_0"}}]),r}(),h="simple",p="weak",d="delegating",f="developer",g=function(){function e(n){var r=n.authType,i=n.sandboxId,o=n.deploymentId;t(this,e),this.authType=r,this.sandboxId=i,this.deploymentId=o}return n(e,[{key:"getHandshakeFields",value:function(e){var t={data:this.authData,type:e.getSandboxId()+"."+this.deploymentId+"."+this.authType,version:this.authVersion};return e.getResource()&&(t.resource=e.getResource()),{ext:{authentication:t}}}},{key:"authVersion",get:function(){return"none"}}]),e}(),v=function(e){function r(e){var n=e.authType,i=e.deploymentId,o=e.token;t(this,r);var u=s(this,(r.__proto__||Object.getPrototypeOf(r)).call(this,{deploymentId:i,authType:n}));return u.token=o,u}return o(r,g),n(r,[{key:"authData",get:function(){return{token:this.token}}}]),r}(),y=function(e){function r(e){var n=e.authType,i=e.deploymentId,o=e.login,u=e.password;t(this,r);var a=s(this,(r.__proto__||Object.getPrototypeOf(r)).call(this,{authType:n,deploymentId:i}));return a.login=o,a.password=u,a}return o(r,g),n(r,[{key:"authData",get:function(){return{login:this.login,password:this.password}}}]),r}(),b=function(){function e(){t(this,e)}return n(e,null,[{key:"simple",value:function(t){var n=t.deploymentId;return e.create({authType:h,deploymentId:void 0===n?c.DEFAULT_DEPLOYMENT_ID:n,login:t.login,password:t.password})}},{key:"weak",value:function(t){var n=t.deploymentId;return e.create({authType:p,deploymentId:void 0===n?l.DEFAULT_DEPLOYMENT_ID:n,login:t.token,password:null})}},{key:"delegating",value:function(t){var n=t.deploymentId;return e.create({authType:d,deploymentId:void 0===n?a.DEFAULT_DEPLOYMENT_ID:n,login:t.token,password:null})}},{key:"developer",value:function(t){return e.create({authType:f,deploymentId:f,login:t.login,password:t.password})}},{key:"create",value:function(e){var t=e.authType,n=e.deploymentId,r=e.login,i=e.password;return null===i?new v({authType:t,deploymentId:n,token:r}):new y({authType:t,deploymentId:n,login:r,password:i})}}]),e}(),m=function(){function e(){t(this,e)}return n(e,[{key:"onConnectionBroken",value:function(){}},{key:"onConnectionClosed",value:function(){}},{key:"onConnectionEstablished",value:function(){}},{key:"onConnectionToServerFail",value:function(e){}},{key:"onNegotiationFailed",value:function(e){}},{key:"onNoServerUrlAvailable",value:function(){}},{key:"onConnectionWillClose",value:function(){}},{key:"onFailedHandshake",value:function(e){}},{key:"onMessageLost",value:function(){}},{key:"onSuccessfulHandshake",value:function(e){}}]),e}(),k={isString:function(e){return void 0!==e&&null!==e&&("string"==typeof e||e instanceof String)},isArray:function(e){return void 0!==e&&null!==e&&e instanceof Array},inArray:function(e,t){for(var n=0;t.length>n;++n)if(e===t[n])return n;return-1},setTimeout:function(e,t,n){return setTimeout(function(){try{e._debug("Invoking timed function",t),t()}catch(n){e._debug("Exception invoking timed function",t,n)}},n)},clearTimeout:function(e){clearTimeout(e)}},_="long-polling",w="websocket",T=function(){var e,t,n;this.registered=function(n,r){e=n,t=r},this.unregistered=function(){e=null,t=null},this._debug=function(){t._debug.apply(t,arguments)},this._mixin=function(){return t._mixin.apply(t,arguments)},this.getConfiguration=function(){return t.getConfiguration()},this.getAdvice=function(){return t.getAdvice()},this.setTimeout=function(e,n){return k.setTimeout(t,e,n)},this.clearTimeout=function(e){k.clearTimeout(e)},this.convertToMessages=function(e){if(k.isString(e))try{return JSON.parse(e)}catch(t){throw this._debug("Could not convert to JSON the following string",'"'+e+'"'),t}if(k.isArray(e))return e;if(void 0===e||null===e)return[];if(e instanceof Object)return[e];throw"Conversion Error "+e+", typeof "+typeof e},this.accept=function(e,t,n){throw"Abstract"},this.getType=function(){return e},this.getURL=function(){return n},this.setURL=function(e){n=e},this.send=function(e,t){throw"Abstract"},this.reset=function(t){this._debug("Transport",e,"reset",t?"initial":"retry")},this.abort=function(){this._debug("Transport",e,"aborted")},this.toString=function(){return this.getType()}};T.derive=function(e){function t(){}return t.prototype=e,new t};var I=function(){var e=new T,t=T.derive(e),n=0,r=null,i=[],o=[];function s(e,t){if(this.transportSend(e,t),t.expired=!1,!e.sync){var n=this.getConfiguration().maxNetworkDelay,r=n;!0===t.metaConnect&&(r+=this.getAdvice().timeout),this._debug("Transport",this.getType(),"waiting at most",r,"ms for the response, maxNetworkDelay",n);var i=this;t.timeout=i.setTimeout(function(){t.expired=!0;var n="Request "+t.id+" of transport "+i.getType()+" exceeded "+r+" ms max network delay",o={reason:n},s=t.xhr;o.httpCode=i.xhrStatus(s),i.abortXHR(s),i._debug(n),i.complete(t,!1,t.metaConnect),e.onFailure(s,e.messages,o)},r)}}function u(e){var t=++n,r={id:t,metaConnect:!1,envelope:e};i.length<this.getConfiguration().maxConnections-1?(i.push(r),s.call(this,e,r)):(this._debug("Transport",this.getType(),"queueing request",t,"envelope",e),o.push([e,r]))}function a(e,t){var n=k.inArray(e,i);if(0>n||i.splice(n,1),o.length>0){var r=o.shift(),s=r[0],a=r[1];if(this._debug("Transport dequeued request",a.id),t)this.getConfiguration().autoBatch&&function(e){for(;o.length>0;){var t=o[0],n=t[0],r=t[1];if(n.url!==e.url||n.sync!==e.sync)break;o.shift(),e.messages=e.messages.concat(n.messages),this._debug("Coalesced",n.messages.length,"messages from request",r.id)}}.call(this,s),u.call(this,s),this._debug("Transport completed request",e.id,s);else{var c=this;c.setTimeout(function(){c.complete(a,!1,a.metaConnect);var e={reason:"Previous request failed"},t=a.xhr;e.httpCode=c.xhrStatus(t),s.onFailure(t,s.messages,e)},0)}}}return t.complete=function(e,t,n){n?function(e){var t=e.id;if(this._debug("Transport",this.getType(),"metaConnect complete, request",t),null!==r&&r.id!==t)throw"Longpoll request mismatch, completing request "+t;r=null}.call(this,e):a.call(this,e,t)},t.transportSend=function(e,t){throw"Abstract"},t.transportSuccess=function(e,t,n){t.expired||(this.clearTimeout(t.timeout),this.complete(t,!0,t.metaConnect),n&&n.length>0?e.onSuccess(n):e.onFailure(t.xhr,e.messages,{httpCode:204}))},t.transportFailure=function(e,t,n){t.expired||(this.clearTimeout(t.timeout),this.complete(t,!1,t.metaConnect),e.onFailure(t.xhr,e.messages,n))},t.send=function(e,t){t?function(e){if(null!==r)throw"Concurrent metaConnect requests not allowed, request id="+r.id+" not yet completed";var t=++n;this._debug("Transport",this.getType(),"metaConnect send, request",t,"envelope",e);var i={id:t,metaConnect:!0,envelope:e};s.call(this,e,i),r=i}.call(this,e):u.call(this,e)},t.abort=function(){e.abort();for(var t=0;i.length>t;++t){var n=i[t];n&&(this._debug("Aborting request",n),this.abortXHR(n.xhr)||this.transportFailure(n.envelope,n,{reason:"abort"}))}r&&(this._debug("Aborting metaConnect request",r),this.abortXHR(r.xhr)||this.transportFailure(r.envelope,r,{reason:"abort"})),this.reset(!0)},t.reset=function(t){e.reset(t),r=null,i=[],o=[]},t.abortXHR=function(e){if(e)try{var t=e.readyState;return e.abort(),t!==XMLHttpRequest.UNSENT}catch(e){this._debug(e)}return!1},t.xhrStatus=function(e){if(e)try{return e.status}catch(e){this._debug(e)}return-1},t},x=function(){var e=new I,t=T.derive(e),n=!0;return t.accept=function(e,t,r){return n||!t},t.xhrSend=function(e){throw"Abstract"},t.transportSend=function(e,t){this._debug("Transport",this.getType(),"sending request",t.id,"envelope",e);var r=this;try{var i=!0;t.xhr=this.xhrSend({transport:this,url:e.url,sync:e.sync,headers:this.getConfiguration().requestHeaders,body:JSON.stringify(e.messages),onSuccess:function(i){r._debug("Transport",r.getType(),"received response",i);var o=!1;try{var s=r.convertToMessages(i);0===s.length?(n=!1,r.transportFailure(e,t,{httpCode:204})):(o=!0,r.transportSuccess(e,t,s))}catch(i){if(r._debug(i),!o){n=!1;var u={exception:i};u.httpCode=r.xhrStatus(t.xhr),r.transportFailure(e,t,u)}}},onError:function(o,s){r._debug("Transport",r.getType(),"received error",o,s),n=!1;var u={reason:o,exception:s};u.httpCode=r.xhrStatus(t.xhr),i?r.setTimeout(function(){r.transportFailure(e,t,u)},0):r.transportFailure(e,t,u)}}),i=!1}catch(i){n=!1,r.setTimeout(function(){r.transportFailure(e,t,{exception:i})},0)}},t.reset=function(t){e.reset(t),n=!0},t};function E(){var e=new x,t=T.derive(e);return t.xhrSend=function(e){E.fetch(e.url,{method:"post",body:e.body,headers:Object.assign(e.headers,{"Content-Type":"application/json;charset=UTF-8"})}).then(function(e){return e.json()}).then(e.onSuccess).catch(e.onError)},t}E.fetch="Abstract";var L=E;function O(){var e,t=new T,n=T.derive(t),r=!0,i=!1,o=!0,s=null,u=null,a=!1,c=null;function l(e,t){e&&(this.webSocketClose(e,t.code,t.reason),this.onClose(e,t))}function h(e){return e===u||e===s}function p(e,t,n){for(var r=[],i=0;t.messages.length>i;++i){var o=t.messages[i];o.id&&r.push(o.id)}e.envelopes[r.join(",")]=[t,n],this._debug("Transport",this.getType(),"stored envelope, envelopes",e.envelopes)}function d(t,n,r){var i=JSON.stringify(n.messages);t.webSocket.send(i),this._debug("Transport",this.getType(),"sent",n,"metaConnect =",r);var o=this.getConfiguration().maxNetworkDelay,s=o;r&&(s+=this.getAdvice().timeout,a=!0);for(var u=this,c=[],h=0;n.messages.length>h;++h)!function(){var r=n.messages[h];r.id&&(c.push(r.id),t.timeouts[r.id]=u.setTimeout(function(){e._debug("Transport",u.getType(),"timing out message",r.id,"after",s,"on",t),l.call(u,t,{code:1e3,reason:"Message Timeout"})},s))}();this._debug("Transport",this.getType(),"waiting at most",s,"ms for messages",c,"maxNetworkDelay",o,", timeouts:",t.timeouts)}function f(t,n,a){try{null===t?(p.call(this,t=u||{envelopes:{},timeouts:{}},n,a),function(t){if(!u){var n=e.getURL().replace(/^http/,"ws");this._debug("Transport",this.getType(),"connecting to URL",n);try{var a=e.getConfiguration().protocol,c=O.WebSocket;t.webSocket=a?new c(n,a):new c(n),u=t}catch(e){throw r=!1,this._debug("Exception while creating WebSocket object",e),e}o=!1!==e.getConfiguration().stickyReconnect;var p=this,d=e.getConfiguration().connectTimeout;d>0&&(t.connectTimer=p.setTimeout(function(){e._debug("Transport",p.getType(),"timed out while connecting to URL",n,":",d,"ms"),l.call(p,t,{code:1e3,reason:"Connect Timeout"})},d));var f=function(n){e._debug("WebSocket onclose",t,n=n||{code:1e3},"connecting",u,"current",s),t.connectTimer&&p.clearTimeout(t.connectTimer),p.onClose(t,n)};t.webSocket.onopen=function(){e._debug("WebSocket onopen",t),t.connectTimer&&p.clearTimeout(t.connectTimer),h(t)?(u=null,s=t,i=!0,p.onOpen(t)):(e._warn("Closing extra WebSocket connection",this,"active connection",s),l.call(p,t,{code:1e3,reason:"Extra Connection"}))},t.webSocket.onclose=f,t.webSocket.onerror=function(){f({code:1e3,reason:"Error"})},t.webSocket.onmessage=function(n){e._debug("WebSocket onmessage",n,t),p.onMessage(t,n)},this._debug("Transport",this.getType(),"configured callbacks on",t)}}.call(this,t)):(p.call(this,t,n,a),d.call(this,t,n,a))}catch(e){var c=this;c.setTimeout(function(){l.call(c,t,{code:1e3,reason:"Exception",exception:e})},0)}}return n.reset=function(e){t.reset(e),r=!0,e&&(i=!1),o=!0,s=null,u=null,a=!1},n._notifySuccess=function(e,t){e.call(this,t)},n._notifyFailure=function(e,t,n,r){e.call(this,t,n,r)},n.onOpen=function(e){var t=e.envelopes;for(var n in this._debug("Transport",this.getType(),"opened",e,"pending messages",t),t)if(t.hasOwnProperty(n)){var r=t[n],i=r[0];c=i.onSuccess,d.call(this,e,i,r[1])}},n.onMessage=function(e,t){this._debug("Transport",this.getType(),"received websocket message",t,e);for(var n=!1,r=this.convertToMessages(t.data),i=[],o=0;r.length>o;++o){var s=r[o];if((/^\/meta\//.test(s.channel)||void 0===s.data)&&s.id){i.push(s.id);var u=e.timeouts[s.id];u&&(this.clearTimeout(u),delete e.timeouts[s.id],this._debug("Transport",this.getType(),"removed timeout for message",s.id,", timeouts",e.timeouts))}"/meta/connect"===s.channel&&(a=!1),"/meta/disconnect"!==s.channel||a||(n=!0)}for(var l=!1,h=e.envelopes,p=0;i.length>p;++p){var d=i[p];for(var f in h)if(h.hasOwnProperty(f)){var g=f.split(","),v=k.inArray(d,g);if(v>=0){l=!0,g.splice(v,1);var y=h[f][0],b=h[f][1];delete h[f],g.length>0&&(h[g.join(",")]=[y,b]);break}}}l&&this._debug("Transport",this.getType(),"removed envelope, envelopes",h),this._notifySuccess(c,r),n&&this.webSocketClose(e,1e3,"Disconnect")},n.onClose=function(e,t){this._debug("Transport",this.getType(),"closed",e,t),h(e)&&(r=o&&i,u=null,s=null);var n=e.timeouts;for(var c in e.timeouts={},n)n.hasOwnProperty(c)&&this.clearTimeout(n[c]);var l=e.envelopes;for(var p in e.envelopes={},l)if(l.hasOwnProperty(p)){var d=l[p][0];l[p][1]&&(a=!1);var f={websocketCode:t.code,reason:t.reason};t.exception&&(f.exception=t.exception),this._notifyFailure(d.onFailure,e,d.messages,f)}},n.registered=function(n,r){t.registered(n,r),e=r},n.accept=function(t,n,i){return this._debug("Transport",this.getType(),"accept, supported:",r),r&&!("string"==typeof O.WebSocket)&&!1!==e.websocketEnabled},n.send=function(e,t){this._debug("Transport",this.getType(),"sending",e,"metaConnect =",t),f.call(this,s,e,t)},n.webSocketClose=function(e,t,n){try{e.webSocket&&e.webSocket.close(t,n)}catch(e){this._debug(e)}},n.abort=function(){t.abort(),l.call(this,s,{code:1e3,reason:"Abort"}),this.reset(!0)},n}O.WebSocket="Abstract";var C=O,S=L.fetch=function(){return fetch.apply(window,arguments)},P=C.WebSocket="undefined"==typeof WebSocket?null:WebSocket,D={type:w,Transport:C},$={type:_,Transport:L},U=function(e){var t,n,r,i,o,s=this,u=e||"default",a=!1,c=new function(){var e=[],t={};this.getTransportTypes=function(){return e.slice(0)},this.findTransportTypes=function(n,r,i){for(var o=[],s=0;e.length>s;++s){var u=e[s];!0===t[u].accept(n,r,i)&&o.push(u)}return o},this.negotiateTransport=function(n,r,i,o){for(var s=0;e.length>s;++s)for(var u=e[s],a=0;n.length>a;++a)if(u===n[a]){var c=t[u];if(!0===c.accept(r,i,o))return c}return null},this.add=function(n,r,i){for(var o=!1,s=0;e.length>s;++s)if(e[s]===n){o=!0;break}return o||("number"!=typeof i?e.push(n):e.splice(i,0,n),t[n]=r),!o},this.find=function(n){for(var r=0;e.length>r;++r)if(e[r]===n)return t[n];return null},this.remove=function(n){for(var r=0;e.length>r;++r)if(e[r]===n){e.splice(r,1);var i=t[n];return delete t[n],i}return null},this.clear=function(){e=[],t={}},this.reset=function(n){for(var r=0;e.length>r;++r)t[e[r]].reset(n)}},l="disconnected",h=0,p=null,d=0,f=[],g=!1,v={},y=0,b=null,m=[],_={},w={},T={},I=!1,x=!1,E=0,L={protocol:null,stickyReconnect:!0,connectTimeout:0,maxConnections:2,backoffIncrement:1e3,maxBackoff:6e4,logLevel:"info",reverseIncomingExtensions:!0,maxNetworkDelay:1e4,requestHeaders:{},appendMessageTypeToURL:!0,autoBatch:!1,urls:{},maxURILength:2e3,advice:{timeout:6e4,interval:0,reconnect:"retry",maxInterval:0}};function O(e,t){try{return e[t]}catch(e){return}}function C(e){return k.isString(e)}function S(e){return void 0!==e&&null!==e&&"function"==typeof e}function P(e,t){for(var n="";--t>0&&Math.pow(10,t)>e;)n+="0";return n+=e}function D(e,t){if(void 0!==console){var n=console[e];if(S(n)){var r=new Date;[].splice.call(t,0,0,P(r.getHours(),2)+":"+P(r.getMinutes(),2)+":"+P(r.getSeconds(),2)+"."+P(r.getMilliseconds(),3)),n.apply(console,t)}}}function $(e){if(e){var t=v[e.channel];t&&t[e.id]&&(delete t[e.id],s._debug("Removed",e.listener?"listener":"subscription",e))}}function U(e){e&&!e.listener&&$(e)}function A(){for(var e in v)if(v.hasOwnProperty(e)){var t=v[e];if(t)for(var n=0;t.length>n;++n)U(t[n])}}function F(e){l!==e&&(s._debug("Status",l,"->",e),l=e)}function N(){return"disconnecting"===l||"disconnected"===l}function R(){return""+ ++h}function M(e,t,n,r,i){try{return t.call(e,r)}catch(e){var o=s.onExtensionException;if(S(o)){s._debug("Invoking extension exception handler",n,e);try{o.call(s,e,n,i,r)}catch(e){s._info("Exception during execution of extension exception handler",n,e)}}else s._info("Exception during execution of extension",n,e);return r}}function j(e){for(var t=0;m.length>t&&void 0!==e&&null!==e;++t){var n=m[t],r=n.extension.outgoing;if(S(r)){var i=M(n.extension,r,n.name,e,!0);e=void 0===i?e:i}}return e}function q(e,t){var n=v[e];if(n&&n.length>0)for(var r=0;n.length>r;++r){var i=n[r];if(i)try{i.callback.call(i.scope,t)}catch(e){var o=s.onListenerException;if(S(o)){s._debug("Invoking listener exception handler",i,e);try{o.call(s,e,i,i.listener,t)}catch(e){s._info("Exception during execution of listener exception handler",i,e)}}else s._info("Exception during execution of listener",i,t,e)}}}function H(e,t){q(e,t);for(var n=e.split("/"),r=n.length-1,i=r;i>0;--i){var o=n.slice(0,i).join("/")+"/*";i===r&&q(o,t),q(o+="*",t)}}function Y(){null!==b&&k.clearTimeout(b),b=null}function B(e,t){void 0===t&&(t=y),Y();var n=_.interval+t;s._debug("Function scheduled in",n,"ms, interval =",_.interval,"backoff =",y,e),b=k.setTimeout(s,e,n)}function W(e,n,r,u){for(var a=0;n.length>a;++a){var c=n[a],l=c.id;p&&(c.clientId=p),void 0!==(c=j(c))&&null!==c?(c.id=l,n[a]=c):(delete w[l],n.splice(a--,1))}if(0!==n.length){var h=s.getURL();L.appendMessageTypeToURL&&(h.match(/\/$/)||(h+="/"),u&&(h+=u));var d={url:h,sync:e,messages:n,onSuccess:function(e){try{i.call(s,e)}catch(e){s._info("Exception during handling of messages",e)}},onFailure:function(e,t,n){try{var r=s.getTransport();n.connectionType=r?r.getType():"unknown",o.call(s,e,t,n)}catch(e){s._info("Exception during handling of failure",e)}}};s._debug("Send",d),t.send(d,r)}}function G(e){d>0||!0===g?f.push(e):W(!1,[e],!1)}function z(){y=0}function Q(){return L.maxBackoff>y&&(y+=L.backoffIncrement),y}function V(){var e=f;f=[],e.length>0&&W(!1,e,!1)}function J(e){F("connecting"),B(function(){!function(){if(!N()){var e={id:R(),channel:"/meta/connect",connectionType:t.getType()};x||(e.advice={timeout:0}),F("connecting"),s._debug("Connect sent",e),W(!1,[e],!0,"connect"),F("connected")}}()},e)}function K(e){e&&(_=s._mixin(!1,{},L.advice,e),s._debug("New advice",_))}function X(e){if(Y(),e&&t&&t.abort(),p=null,F("disconnected"),d=0,z(),t=null,f.length>0){var n=f;f=[],o.call(s,void 0,n,{reason:"Disconnected"})}}function Z(e,t,n){var r=s.onTransportException;if(S(r)){s._debug("Invoking transport exception handler",e,t,n);try{r.call(s,n,e,t)}catch(e){s._info("Exception during execution of transport exception handler",e)}}}function ee(e,i){S(e)&&(i=e,e=void 0),p=null,A(),N()?(c.reset(!0),K(L.advice)):K(s._mixin(!1,_,{reconnect:"retry"})),d=0,g=!0,n=e,r=i;var o=s.getURL(),u=c.findTransportTypes("1.0",a,o),l={id:R(),version:"1.0",minimumVersion:"1.0",channel:"/meta/handshake",supportedConnectionTypes:u,advice:{timeout:_.timeout,interval:_.interval}},h=s._mixin(!1,{},n,l);if(s._putCallback(h.id,i),!t&&!(t=c.negotiateTransport(u,"1.0",a,o))){var f="Could not find initial transport among: "+c.getTransportTypes();throw s._warn(f),f}s._debug("Initial transport is",t.getType()),F("handshaking"),s._debug("Handshake sent",h),W(!1,[h],!1,"handshake")}function te(e){F("handshaking"),g=!0,B(function(){ee(n,r)},e)}function ne(e,t){try{e.call(s,t)}catch(e){var n=s.onCallbackException;if(S(n)){s._debug("Invoking callback exception handler",e);try{n.call(s,e,t)}catch(e){s._info("Exception during execution of callback exception handler",e)}}else s._info("Exception during execution of message callback",e)}}function re(e){var t=s._getCallback([e.id]);S(t)&&(delete w[e.id],ne(t,e))}function ie(e){var t=T[e.id];if(delete T[e.id],s._debug("Handling remote call response for",e,"with context",t),t){var n=t.timeout;n&&k.clearTimeout(n);var r=t.callback;if(S(r))return ne(r,e),!0}return!1}function oe(e){re(e),H("/meta/handshake",e),H("/meta/unsuccessful",e),N()||"none"===_.reconnect?X(!0):(Q(),te())}function se(e){var n=s.getURL(),r=s.getTransport(),i=c.findTransportTypes("1.0",a,n),o=c.negotiateTransport(i,"1.0",a,n);o?(s._debug("Transport",r.getType(),"->",o.getType()),Z(r.getType(),o.getType(),e.failure),oe(e),t=o):(Z(r.getType(),null,e.failure),s._warn("Could not negotiate transport; client=["+i+"]"),X(!0),oe(e))}function ue(e){H("/meta/connect",e),H("/meta/unsuccessful",e);var t=N()?"none":_.reconnect;switch(t){case"retry":J(),Q();break;case"handshake":c.reset(!0),z(),te();break;case"none":X(!0);break;default:throw"Unrecognized advice action"+t}}function ae(e){x=!1,ue(e)}function ce(e){X(!0),re(e),H("/meta/disconnect",e),H("/meta/unsuccessful",e)}function le(e){ce(e)}function he(e){var t=v[e.subscription];if(t)for(var n=t.length-1;n>=0;--n){var r=t[n];if(r&&!r.listener){delete t[n],s._debug("Removed failed subscription",r);break}}re(e),H("/meta/subscribe",e),H("/meta/unsuccessful",e)}function pe(e){he(e)}function de(e){re(e),H("/meta/unsubscribe",e),H("/meta/unsuccessful",e)}function fe(e){de(e)}function ge(e){ie(e)||(re(e),H("/meta/publish",e),H("/meta/unsuccessful",e))}function ve(e){ge(e)}function ye(e){if(void 0!==(e=function(e){for(var t=0;m.length>t&&void 0!==e&&null!==e;++t){var n=m[L.reverseIncomingExtensions?m.length-1-t:t],r=n.extension.incoming;if(S(r)){var i=M(n.extension,r,n.name,e,!1);e=void 0===i?e:i}}return e}(e))&&null!==e)switch(K(e.advice),e.channel){case"/meta/handshake":!function(e){if(e.successful){p=e.clientId;var n=s.getURL(),r=c.negotiateTransport(e.supportedConnectionTypes,e.version,a,n);if(null===r){var i="Could not negotiate transport with server; client=["+c.findTransportTypes(e.version,a,n)+"], server=["+e.supportedConnectionTypes+"]",o=s.getTransport();return Z(o.getType(),null,{reason:i,connectionType:o.getType(),transport:o}),s._warn(i),void X(!0)}t!==r&&(s._debug("Transport",t.getType(),"->",r.getType()),t=r),g=!1,V(),e.reestablish=I,I=!0,re(e),H("/meta/handshake",e);var u=N()?"none":_.reconnect;switch(u){case"retry":z(),J();break;case"none":X(!0);break;default:throw"Unrecognized advice action "+u}}else oe(e)}(e);break;case"/meta/connect":!function(e){if(x=e.successful){H("/meta/connect",e);var t=N()?"none":_.reconnect;switch(t){case"retry":z(),J();break;case"none":X(!1);break;default:throw"Unrecognized advice action "+t}}else ue(e)}(e);break;case"/meta/disconnect":!function(e){e.successful?(X(!1),re(e),H("/meta/disconnect",e)):ce(e)}(e);break;case"/meta/subscribe":!function(e){e.successful?(re(e),H("/meta/subscribe",e)):he(e)}(e);break;case"/meta/unsubscribe":!function(e){e.successful?(re(e),H("/meta/unsubscribe",e)):de(e)}(e);break;default:!function(e){void 0!==e.data?ie(e)||(H(e.channel,e),E>0&&0==--E&&(s._debug("Processed last handshake-delivered message"),J(0))):void 0===e.successful?s._warn("Unknown Bayeux Message",e):e.successful?(re(e),H("/meta/publish",e)):ge(e)}(e)}}function be(e){var t=v[e];if(t)for(var n=0;t.length>n;++n)if(t[n])return!0;return!1}function me(e,t){var n={scope:e,method:t};if(S(e))n.scope=void 0,n.method=e;else if(C(t)){if(!e)throw"Invalid scope "+e;if(n.method=e[t],!S(n.method))throw"Invalid callback "+t+" for scope "+e}else if(!S(t))throw"Invalid callback "+t;return n}function ke(e,t,n,r){var i=me(t,n);s._debug("Adding",r?"listener":"subscription","on",e,"with scope",i.scope,"and callback",i.method);var o={channel:e,scope:i.scope,callback:i.method,listener:r},u=v[e];return u||(v[e]=u=[]),o.id=u.push(o)-1,s._debug("Added",r?"listener":"subscription",o),o[0]=e,o[1]=o.id,o}this._mixin=function(e,t,n){for(var r=t||{},i=2;arguments.length>i;++i){var o=arguments[i];if(void 0!==o&&null!==o)for(var s in o)if(o.hasOwnProperty(s)){var u=O(o,s),a=O(r,s);if(u===t)continue;if(void 0===u)continue;r[s]=e&&"object"==typeof u&&null!==u?this._mixin(e,u instanceof Array?a instanceof Array?a:[]:"object"!=typeof a||a instanceof Array?{}:a,u):u}}return r},this._warn=function(){D("warn",arguments)},this._info=function(){"warn"!==L.logLevel&&D("info",arguments)},this._debug=function(){"debug"===L.logLevel&&D("debug",arguments)},this._isCrossDomain=function(e){var t="undefined"==typeof location?e:location.host;return e&&e!==t},this.send=G,this._getCallback=function(e){return w[e]},this._putCallback=function(e,t){var n=this._getCallback(e);return S(t)&&(w[e]=t),n},this.receive=ye,i=function(e){s._debug("Received",e);for(var t=0;e.length>t;++t)ye(e[t])},o=function(e,t,n){s._debug("handleFailure",e,t,n),n.transport=e;for(var r=0;t.length>r;++r){var i=t[r],o={id:i.id,successful:!1,channel:i.channel,failure:n};switch(n.message=i,i.channel){case"/meta/handshake":se(o);break;case"/meta/connect":ae(o);break;case"/meta/disconnect":le(o);break;case"/meta/subscribe":o.subscription=i.subscription,pe(o);break;case"/meta/unsubscribe":o.subscription=i.subscription,fe(o);break;default:ve(o)}}},this.registerTransport=function(e,t,n){var r=c.add(e,t,n);return r&&(this._debug("Registered transport",e),S(t.registered)&&t.registered(e,this)),r},this.unregisterTransport=function(e){var t=c.remove(e);return null!==t&&(this._debug("Unregistered transport",e),S(t.unregistered)&&t.unregistered()),t},this.unregisterTransports=function(){c.clear()},this.getTransportTypes=function(){return c.getTransportTypes()},this.findTransport=function(e){return c.find(e)},this.getTransportRegistry=function(){return c},this.configure=function(e){!function(e){s._debug("Configuring cometd object with",e),C(e)&&(e={url:e}),e||(e={}),L=s._mixin(!1,L,e);var t=s.getURL();if(!t)throw"Missing required configuration parameter 'url' specifying the Bayeux server URL";var n=function(e){return/(^https?:\/\/)?(((\[[^\]]+\])|([^:\/\?#]+))(:(\d+))?)?([^\?#]*)(.*)?/.exec(e)}(t),r=n[8],i=n[9];if(a=s._isCrossDomain(n[2]),L.appendMessageTypeToURL)if(void 0!==i&&i.length>0)s._info("Appending message type to URI "+r+i+" is not supported, disabling 'appendMessageTypeToURL' configuration"),L.appendMessageTypeToURL=!1;else{var o=r.split("/"),u=o.length-1;r.match(/\/$/)&&(u-=1),0>o[u].indexOf(".")||(s._info("Appending message type to URI "+r+" is not supported, disabling 'appendMessageTypeToURL' configuration"),L.appendMessageTypeToURL=!1)}}(e)},this.init=function(e,t){this.configure(e),this.handshake(t)},this.handshake=function(e,t){F("disconnected"),I=!1,ee(e,t)},this.disconnect=function(e,t,n){if(!N()){"boolean"!=typeof e&&(n=t,t=e,e=!1),S(t)&&(n=t,t=void 0);var r={id:R(),channel:"/meta/disconnect"},i=this._mixin(!1,{},t,r);s._putCallback(i.id,n),F("disconnecting"),W(!0===e,[i],!1,"disconnect")}},this.startBatch=function(){s._debug("Starting batch, depth",++d)},this.endBatch=function(){!function(){if(s._debug("Ending batch, depth",--d),0>d)throw"Calls to startBatch() and endBatch() are not paired";0!==d||N()||g||V()}()},this.batch=function(e,t){var n=me(e,t);this.startBatch();try{n.method.call(n.scope),this.endBatch()}catch(e){throw this._info("Exception during execution of batch",e),this.endBatch(),e}},this.addListener=function(e,t,n){if(2>arguments.length)throw"Illegal arguments number: required 2, got "+arguments.length;if(!C(e))throw"Illegal argument type: channel must be a string";return ke(e,t,n,!0)},this.removeListener=function(e){if(!(e&&e.channel&&"id"in e))throw"Invalid argument: expected subscription, not "+e;$(e)},this.clearListeners=function(){v={}},this.subscribe=function(e,t,n,r,i){if(2>arguments.length)throw"Illegal arguments number: required 2, got "+arguments.length;if(!C(e))throw"Illegal argument type: channel must be a string";if(N())throw"Illegal state: already disconnected";S(t)&&(i=r,r=n,n=t,t=void 0),S(r)&&(i=r,r=void 0);var o=!be(e),u=ke(e,t,n,!1);if(o){var a={id:R(),channel:"/meta/subscribe",subscription:e},c=this._mixin(!1,{},r,a);s._putCallback(c.id,i),G(c)}return u},this.unsubscribe=function(e,t,n){if(1>arguments.length)throw"Illegal arguments number: required 1, got "+arguments.length;if(N())throw"Illegal state: already disconnected";S(t)&&(n=t,t=void 0),this.removeListener(e);var r=e.channel;if(!be(r)){var i={id:R(),channel:"/meta/unsubscribe",subscription:r},o=this._mixin(!1,{},t,i);s._putCallback(o.id,n),G(o)}},this.resubscribe=function(e,t){if(U(e),e)return this.subscribe(e.channel,e.scope,e.callback,t)},this.clearSubscriptions=function(){A()},this.publish=function(e,t,n,r){if(1>arguments.length)throw"Illegal arguments number: required 1, got "+arguments.length;if(!C(e))throw"Illegal argument type: channel must be a string";if(/^\/meta\//.test(e))throw"Illegal argument: cannot publish to meta channels";if(N())throw"Illegal state: already disconnected";S(t)?(r=t,t=n={}):S(n)&&(r=n,n={});var i={id:R(),channel:e,data:t},o=this._mixin(!1,{},n,i);s._putCallback(o.id,r),G(o)},this.remoteCall=function(e,t,n,r){if(1>arguments.length)throw"Illegal arguments number: required 1, got "+arguments.length;if(!C(e))throw"Illegal argument type: target must be a string";if(N())throw"Illegal state: already disconnected";if(S(t)?(r=t,t={},n=L.maxNetworkDelay):S(n)&&(r=n,n=L.maxNetworkDelay),"number"!=typeof n)throw"Illegal argument type: timeout must be a number";e.match(/^\//)||(e="/"+e);var i="/service"+e,o={id:R(),channel:i,data:t},u={callback:r};n>0&&(u.timeout=k.setTimeout(s,function(){s._debug("Timing out remote call",o,"after",n,"ms"),ge({id:o.id,error:"406::timeout",successful:!1,failure:{message:o,reason:"Remote Call Timeout"}})},n),s._debug("Scheduled remote call timeout",o,"in",n,"ms")),T[o.id]=u,G(o)},this.getStatus=function(){return l},this.isDisconnected=N,this.setBackoffIncrement=function(e){L.backoffIncrement=e},this.getBackoffIncrement=function(){return L.backoffIncrement},this.getBackoffPeriod=function(){return y},this.increaseBackoffPeriod=function(){return Q()},this.resetBackoffPeriod=function(){z()},this.setLogLevel=function(e){L.logLevel=e},this.registerExtension=function(e,t){if(2>arguments.length)throw"Illegal arguments number: required 2, got "+arguments.length;if(!C(e))throw"Illegal argument type: extension name must be a string";for(var n=!1,r=0;m.length>r;++r)if(m[r].name===e){n=!0;break}return n?(this._info("Could not register extension with name",e,"since another extension with the same name already exists"),!1):(m.push({name:e,extension:t}),this._debug("Registered extension",e),S(t.registered)&&t.registered(e,this),!0)},this.unregisterExtension=function(e){if(!C(e))throw"Illegal argument type: extension name must be a string";for(var t=!1,n=0;m.length>n;++n){var r=m[n];if(r.name===e){m.splice(n,1),t=!0,this._debug("Unregistered extension",e);var i=r.extension;S(i.unregistered)&&i.unregistered();break}}return t},this.getExtension=function(e){for(var t=0;m.length>t;++t){var n=m[t];if(n.name===e)return n.extension}return null},this.getName=function(){return u},this.getClientId=function(){return p},this.getURL=function(){if(t){var e=t.getURL();if(e)return e;if(e=L.urls[t.getType()])return e}return L.url},this.getTransport=function(){return t},this.getConfiguration=function(){return this._mixin(!0,{},L)},this.getAdvice=function(){return this._mixin(!0,{},_)}},A={fetch:S,WebSocket:P,WEBSOCKET_TRANSPORT:D,LONG_POLLING_TRANSPORT:$,ALL:[D,$]},F=function(e){function r(){return t(this,r),s(this,(r.__proto__||Object.getPrototypeOf(r)).apply(this,arguments))}return o(r,u),n(r,[{key:"push",value:function(e){return this.$publish("push",{items:e.items,owner:e.owner})}}],[{key:"DEFAULT_DEPLOYMENT_ID",get:function(){return"aggreg_0"}}]),r}(),N=function(e){function r(){return t(this,r),s(this,(r.__proto__||Object.getPrototypeOf(r)).apply(this,arguments))}return o(r,u),n(r,[{key:"getListeners",value:function(e){return this.$publish("getListeners",{stack:e.stack,owner:e.owner})}},{key:"list",value:function(e){return this.$publish("list",{stack:e.stack,owner:e.owner,page:e.page})}},{key:"purge",value:function(e){return this.$publish("purge",{stack:e.stack,owner:e.owner})}},{key:"push",value:function(e){return this.$publish("push",{stack:e.stack,data:e.data,owner:e.owner})}},{key:"remove",value:function(e){return this.$publish("remove",{guids:e.guids,stack:e.stack,owner:e.owner})}},{key:"setListeners",value:function(e){return this.$publish("setListeners",{listeners:e.listeners,stack:e.stack,owner:e.owner})}},{key:"update",value:function(e){return this.$publish("update",{guid:e.guid,stack:e.stack,data:e.data,owner:e.owner})}}],[{key:"DEFAULT_DEPLOYMENT_ID",get:function(){return"stack_0"}}]),r}(),R=function(e){function r(){return t(this,r),s(this,(r.__proto__||Object.getPrototypeOf(r)).apply(this,arguments))}return o(r,u),n(r,[{key:"echo",value:function(e){return this.$publish("echo",e)}}],[{key:"DEFAULT_DEPLOYMENT_ID",get:function(){return"echo_0"}}]),r}(),M=function(e){function r(){return t(this,r),s(this,(r.__proto__||Object.getPrototypeOf(r)).apply(this,arguments))}return o(r,u),n(r,[{key:"available",value:function(){return this.$publish("available",{})}},{key:"join",value:function(e){return this.$publish("join",{role:e.role,gameId:e.gameId,userId:e.userId,userName:e.userName})}},{key:"organize",value:function(e){return this.$publish("organize",{type:e.type,owner:e.owner,options:e.options})}},{key:"play",value:function(e){return this.$publish("play",{gameId:e.gameId,userId:e.userId,data:e.data})}},{key:"start",value:function(e){return this.$publish("start",{gameId:e.gameId})}},{key:"unjoin",value:function(e){return this.$publish("unjoin",{role:e.role,gameId:e.gameId,userId:e.userId,userName:e.userName})}}],[{key:"DEFAULT_DEPLOYMENT_ID",get:function(){return"game_0"}}]),r}(),j=function(e){function r(){return t(this,r),s(this,(r.__proto__||Object.getPrototypeOf(r)).apply(this,arguments))}return o(r,u),n(r,[{key:"join_result",value:function(e){return this.$publish("join_result",{msgId:e.msgId,payload:e.payload,error:e.error,callerId:e.callerId})}},{key:"organize_result",value:function(e){return this.$publish("organize_result",{msgId:e.msgId,payload:e.payload,error:e.error,callerId:e.callerId})}},{key:"register",value:function(e){return this.$publish("register",{maxGames:e.maxGames,gameInfo:e.gameInfo,location:e.location})}},{key:"start_result",value:function(e){return this.$publish("start_result",{gameId:e.gameId})}},{key:"state",value:function(e){return this.$publish("state",{status:e.status,gameId:e.gameId,data:e.data})}},{key:"unjoin_result",value:function(e){return this.$publish("unjoin_result",{msgId:e.msgId,payload:e.payload,error:e.error,callerId:e.callerId})}}],[{key:"DEFAULT_DEPLOYMENT_ID",get:function(){return"game_0"}}]),r}(),q=function(e){function r(){return t(this,r),s(this,(r.__proto__||Object.getPrototypeOf(r)).apply(this,arguments))}return o(r,u),n(r,[{key:"get",value:function(e){return this.$publish("get",{table:e.table,key:e.key,owner:e.owner})}},{key:"getCells",value:function(e){return this.$publish("getCells",{table:e.table,key:e.key,key2:e.key2,owner:e.owner,column:e.column})}},{key:"inc",value:function(e){return this.$publish("inc",{table:e.table,data:e.data,key:e.key,key2:e.key2,owner:e.owner,column:e.column})}},{key:"list",value:function(e){return this.$publish("list",{columns:e.columns,table:e.table,owner:e.owner,page:e.page})}},{key:"put",value:function(e){return this.$publish("put",{table:e.table,data:e.data,key:e.key,key2:e.key2,owner:e.owner,column:e.column})}},{key:"puts",value:function(e){return this.$publish("puts",{rows:e.rows,table:e.table,owner:e.owner})}},{key:"range",value:function(e){return this.$publish("range",{columns:e.columns,start:e.start,table:e.table,stop:e.stop,owner:e.owner,page:e.page})}},{key:"removeCell",value:function(e){return this.$publish("removeCell",{table:e.table,key:e.key,key2:e.key2,owner:e.owner,column:e.column})}},{key:"removeColumn",value:function(e){return this.$publish("removeColumn",{table:e.table,key:e.key,owner:e.owner,column:e.column})}},{key:"removeRange",value:function(e){return this.$publish("removeRange",{columns:e.columns,start:e.start,table:e.table,stop:e.stop,owner:e.owner})}},{key:"removeRow",value:function(e){return this.$publish("removeRow",{table:e.table,key:e.key,owner:e.owner})}}],[{key:"DEFAULT_DEPLOYMENT_ID",get:function(){return"gda_0"}}]),r}(),H=function(e){function r(){return t(this,r),s(this,(r.__proto__||Object.getPrototypeOf(r)).apply(this,arguments))}return o(r,u),n(r,[{key:"addListener",value:function(e){return this.$publish("addListener",{resource:e.resource,fromResource:e.fromResource,cmd:e.cmd,from:e.from,data:e.data,owner:e.owner})}},{key:"capabilities",value:function(e){return this.$publish("capabilities",{askingResource:e.askingResource,capabilities:e.capabilities,answeringResource:e.answeringResource})}},{key:"execute",value:function(e){return this.$publish("execute",{resource:e.resource,cmd:e.cmd,data:e.data,owner:e.owner})}},{key:"getCapabilities",value:function(){return this.$publish("getCapabilities",{})}},{key:"notify",value:function(e){return this.$publish("notify",{resource:e.resource,fromResource:e.fromResource,cmd:e.cmd,from:e.from,data:e.data,owner:e.owner})}},{key:"ping",value:function(e){return this.$publish("ping",{action:e.action})}},{key:"pong",value:function(e){return this.$publish("pong",{user:e.user,resource:e.resource,available:e.available,uid:e.uid,owner:e.owner,action:e.action})}},{key:"removeListener",value:function(e){return this.$publish("removeListener",{resource:e.resource,fromResource:e.fromResource,cmd:e.cmd,from:e.from,data:e.data,owner:e.owner})}}],[{key:"DEFAULT_DEPLOYMENT_ID",get:function(){return"groups_0"}}]),r}(),Y=function(e){function r(){return t(this,r),s(this,(r.__proto__||Object.getPrototypeOf(r)).apply(this,arguments))}return o(r,u),n(r,[{key:"addMe",value:function(e){return this.$publish("addMe",{group:e.group,owner:e.owner})}},{key:"addUser",value:function(e){return this.$publish("addUser",{user:e.user,group:e.group,owner:e.owner})}},{key:"addUsers",value:function(e){return this.$publish("addUsers",{users:e.users,group:e.group,owner:e.owner})}},{key:"allGroups",value:function(e){return this.$publish("allGroups",{owner:e.owner})}},{key:"createGroup",value:function(e){return this.$publish("createGroup",{group:e.group,groupName:e.groupName,owner:e.owner})}},{key:"delGroup",value:function(e){return this.$publish("delGroup",{group:e.group,owner:e.owner})}},{key:"delUser",value:function(e){return this.$publish("delUser",{user:e.user,group:e.group,owner:e.owner})}},{key:"delUsers",value:function(e){return this.$publish("delUsers",{users:e.users,group:e.group,groupName:e.groupName,owner:e.owner})}},{key:"exists",value:function(e){return this.$publish("exists",{group:e.group,owner:e.owner})}},{key:"grant",value:function(e){return this.$publish("grant",{resource:e.resource,group:e.group,owner:e.owner,action:e.action})}},{key:"groupUsers",value:function(e){return this.$publish("groupUsers",{group:e.group,owner:e.owner})}},{key:"groups",value:function(e){return this.$publish("groups",{owner:e.owner})}},{key:"listGrants",value:function(e){return this.$publish("listGrants",{group:e.group,owner:e.owner})}},{key:"listPresences",value:function(e){return this.$publish("listPresences",{group:e.group,owner:e.owner})}},{key:"memberOf",value:function(e){return this.$publish("memberOf",{hardFail:e.hardFail,group:e.group,owner:e.owner})}},{key:"mgrant",value:function(e){return this.$publish("mgrant",{resource:e.resource,actions:e.actions,group:e.group,owner:e.owner})}},{key:"mrevoke",value:function(e){return this.$publish("mrevoke",{resource:e.resource,actions:e.actions,group:e.group,owner:e.owner})}},{key:"myGroups",value:function(e){return this.$publish("myGroups",{owner:e.owner})}},{key:"revoke",value:function(e){return this.$publish("revoke",{resource:e.resource,group:e.group,owner:e.owner,action:e.action})}}],[{key:"DEFAULT_DEPLOYMENT_ID",get:function(){return"groups_0"}}]),r}(),B=function(e){function r(){return t(this,r),s(this,(r.__proto__||Object.getPrototypeOf(r)).apply(this,arguments))}return o(r,u),n(r,[{key:"call",value:function(e){return this.$publish("call",{name:e.name,requestId:e.requestId})}}],[{key:"DEFAULT_DEPLOYMENT_ID",get:function(){return"httpclient_0"}}]),r}(),W=function(e){function r(){return t(this,r),s(this,(r.__proto__||Object.getPrototypeOf(r)).apply(this,arguments))}return o(r,u),n(r,[{key:"breakpoint",value:function(e){return this.$publish("breakpoint",{breakpoint:e.breakpoint,token:e.token,enabled:e.enabled})}},{key:"info",value:function(e){return this.$publish("info",{token:e.token,path:e.path,exp:e.exp,requestId:e.requestId,frame:e.frame})}},{key:"livedebug",value:function(e){return this.$publish("livedebug",{parameters:e.parameters,token:e.token,breakpoints:e.breakpoints,hardFail:e.hardFail,name:e.name,requestId:e.requestId,debug:e.debug})}},{key:"resume",value:function(e){return this.$publish("resume",{token:e.token,type:e.type})}},{key:"variable",value:function(e){return this.$publish("variable",{token:e.token,name:e.name,frame:e.frame,data:e.data})}}],[{key:"DEFAULT_DEPLOYMENT_ID",get:function(){return"macro_0"}}]),r}(),G=function(e){function r(){return t(this,r),s(this,(r.__proto__||Object.getPrototypeOf(r)).apply(this,arguments))}return o(r,u),n(r,[{key:"call",value:function(e){return this.$publish("call",{parameters:e.parameters,hardFail:e.hardFail,name:e.name,requestId:e.requestId,debug:e.debug})}}],[{key:"DEFAULT_DEPLOYMENT_ID",get:function(){return"macro_0"}}]),r}(),z=function(e){function r(){return t(this,r),s(this,(r.__proto__||Object.getPrototypeOf(r)).apply(this,arguments))}return o(r,u),n(r,null,[{key:"DEFAULT_DEPLOYMENT_ID",get:function(){return"sendmail_0"}}]),r}(),Q=function(e){function r(){return t(this,r),s(this,(r.__proto__||Object.getPrototypeOf(r)).apply(this,arguments))}return o(r,u),n(r,[{key:"send",value:function(e){return this.$publish("send",{target:e.target,channel:e.channel,data:e.data})}}],[{key:"DEFAULT_DEPLOYMENT_ID",get:function(){return"messaging_0"}}]),r}(),V=function(e){function r(){return t(this,r),s(this,(r.__proto__||Object.getPrototypeOf(r)).apply(this,arguments))}return o(r,u),n(r,[{key:"call",value:function(e){return this.$publish("call",{description:e.description,originBusinessId:e.originBusinessId,originDeploymentId:e.originDeploymentId,data:e.data,owner:e.owner})}},{key:"done",value:function(e){return this.$publish("done",{target:e.target,result:e.result,taskId:e.taskId,requestId:e.requestId,success:e.success})}},{key:"register",value:function(e){return this.$publish("register",{capacity:e.capacity})}},{key:"submit",value:function(e){return this.$publish("submit",{description:e.description,originBusinessId:e.originBusinessId,originDeploymentId:e.originDeploymentId,data:e.data,owner:e.owner})}},{key:"unregister",value:function(){return this.$publish("unregister",{})}}],[{key:"DEFAULT_DEPLOYMENT_ID",get:function(){return"queue_0"}}]),r}(),J=function(e){function r(){return t(this,r),s(this,(r.__proto__||Object.getPrototypeOf(r)).apply(this,arguments))}return o(r,u),n(r,null,[{key:"DEFAULT_DEPLOYMENT_ID",get:function(){return"notif_0"}}]),r}(),K=function(e){function r(){return t(this,r),s(this,(r.__proto__||Object.getPrototypeOf(r)).apply(this,arguments))}return o(r,u),n(r,null,[{key:"DEFAULT_DEPLOYMENT_ID",get:function(){return"rdbms_0"}}]),r}(),X=function(e){function r(){return t(this,r),s(this,(r.__proto__||Object.getPrototypeOf(r)).apply(this,arguments))}return o(r,u),n(r,null,[{key:"DEFAULT_DEPLOYMENT_ID",get:function(){return"sms_ovh_0"}}]),r}(),Z=function(e){function r(){return t(this,r),s(this,(r.__proto__||Object.getPrototypeOf(r)).apply(this,arguments))}return o(r,u),n(r,[{key:"list",value:function(e){return this.$publish("list",{start:e.start,stop:e.stop,owner:e.owner,page:e.page})}}],[{key:"DEFAULT_DEPLOYMENT_ID",get:function(){return"cron_0"}}]),r}(),ee=function(e){function r(){return t(this,r),s(this,(r.__proto__||Object.getPrototypeOf(r)).apply(this,arguments))}return o(r,u),n(r,[{key:"delete",value:function(e){return this.$publish("delete",{type:e.type,id:e.id,index:e.index})}},{key:"get",value:function(e){return this.$publish("get",{type:e.type,id:e.id,index:e.index})}},{key:"index",value:function(e){return this.$publish("index",{type:e.type,id:e.id,index:e.index,data:e.data})}},{key:"search",value:function(e){return this.$publish("search",{indices:e.indices,query:e.query,sort:e.sort,page:e.page,types:e.types})}}],[{key:"DEFAULT_DEPLOYMENT_ID",get:function(){return"search_0"}}]),r}(),te=function(e){function r(){return t(this,r),s(this,(r.__proto__||Object.getPrototypeOf(r)).apply(this,arguments))}return o(r,u),n(r,[{key:"evaluate",value:function(e){return this.$publish("evaluate",{languageTag:e.languageTag,name:e.name,requestId:e.requestId,data:e.data})}}],[{key:"DEFAULT_DEPLOYMENT_ID",get:function(){return"template_0"}}]),r}(),ne=function(e){function r(){return t(this,r),s(this,(r.__proto__||Object.getPrototypeOf(r)).apply(this,arguments))}return o(r,u),n(r,null,[{key:"DEFAULT_DEPLOYMENT_ID",get:function(){return"trigger_0"}}]),r}(),re=function(e){function r(){return t(this,r),s(this,(r.__proto__||Object.getPrototypeOf(r)).apply(this,arguments))}return o(r,u),n(r,[{key:"cp",value:function(e){return this.$publish("cp",{oldPath:e.oldPath,path:e.path,owner:e.owner})}},{key:"du",value:function(e){return this.$publish("du",{path:e.path,owner:e.owner})}},{key:"link",value:function(e){return this.$publish("link",{oldPath:e.oldPath,path:e.path,owner:e.owner})}},{key:"ls",value:function(e){return this.$publish("ls",{folder:e.folder,owner:e.owner,page:e.page})}},{key:"mkdir",value:function(e){return this.$publish("mkdir",{parents:e.parents,folder:e.folder,owner:e.owner})}},{key:"mv",value:function(e){return this.$publish("mv",{oldPath:e.oldPath,path:e.path,owner:e.owner})}},{key:"newFile",value:function(e){return this.$publish("newFile",{tags:e.tags,guid:e.guid,metadata:e.metadata,owner:e.owner})}},{key:"newUploadUrl",value:function(e){return this.$publish("newUploadUrl",{contentType:e.contentType,path:e.path,owner:e.owner})}},{key:"rm",value:function(e){return this.$publish("rm",{path:e.path,owner:e.owner})}},{key:"snapshot",value:function(e){return this.$publish("snapshot",{parents:e.parents,folder:e.folder,items:e.items,flatten:e.flatten,owner:e.owner})}},{key:"stat",value:function(e){return this.$publish("stat",{path:e.path,owner:e.owner})}},{key:"updateMeta",value:function(e){return this.$publish("updateMeta",{path:e.path,metadataFiles:e.metadataFiles,metadata:e.metadata,owner:e.owner})}}],[{key:"DEFAULT_DEPLOYMENT_ID",get:function(){return"zpfs_s3_0"}}]),r}(),ie=function(e){function r(){return t(this,r),s(this,(r.__proto__||Object.getPrototypeOf(r)).apply(this,arguments))}return o(r,u),n(r,[{key:"cp",value:function(e){return this.$publish("cp",{oldPath:e.oldPath,path:e.path,owner:e.owner})}},{key:"du",value:function(e){return this.$publish("du",{path:e.path,owner:e.owner})}},{key:"link",value:function(e){return this.$publish("link",{oldPath:e.oldPath,path:e.path,owner:e.owner})}},{key:"ls",value:function(e){return this.$publish("ls",{folder:e.folder,owner:e.owner,page:e.page})}},{key:"mkdir",value:function(e){return this.$publish("mkdir",{parents:e.parents,folder:e.folder,owner:e.owner})}},{key:"mv",value:function(e){return this.$publish("mv",{oldPath:e.oldPath,path:e.path,owner:e.owner})}},{key:"newFile",value:function(e){return this.$publish("newFile",{tags:e.tags,guid:e.guid,metadata:e.metadata,owner:e.owner})}},{key:"newUploadUrl",value:function(e){return this.$publish("newUploadUrl",{contentType:e.contentType,path:e.path,owner:e.owner})}},{key:"rm",value:function(e){return this.$publish("rm",{path:e.path,owner:e.owner})}},{key:"snapshot",value:function(e){return this.$publish("snapshot",{parents:e.parents,folder:e.folder,items:e.items,flatten:e.flatten,owner:e.owner})}},{key:"stat",value:function(e){return this.$publish("stat",{path:e.path,owner:e.owner})}},{key:"updateMeta",value:function(e){return this.$publish("updateMeta",{path:e.path,metadataFiles:e.metadataFiles,metadata:e.metadata,owner:e.owner})}}],[{key:"DEFAULT_DEPLOYMENT_ID",get:function(){return"zpfs_hdfs_0"}}]),r}(),oe=function(e){function r(){return t(this,r),s(this,(r.__proto__||Object.getPrototypeOf(r)).apply(this,arguments))}return o(r,u),n(r,[{key:"cp",value:function(e){return this.$publish("cp",{oldPath:e.oldPath,path:e.path,owner:e.owner})}},{key:"du",value:function(e){return this.$publish("du",{path:e.path,owner:e.owner})}},{key:"link",value:function(e){return this.$publish("link",{oldPath:e.oldPath,path:e.path,owner:e.owner})}},{key:"ls",value:function(e){return this.$publish("ls",{folder:e.folder,owner:e.owner,page:e.page})}},{key:"mkdir",value:function(e){return this.$publish("mkdir",{parents:e.parents,folder:e.folder,owner:e.owner})}},{key:"mv",value:function(e){return this.$publish("mv",{oldPath:e.oldPath,path:e.path,owner:e.owner})}},{key:"newFile",value:function(e){return this.$publish("newFile",{tags:e.tags,guid:e.guid,metadata:e.metadata,owner:e.owner})}},{key:"newUploadUrl",value:function(e){return this.$publish("newUploadUrl",{contentType:e.contentType,path:e.path,owner:e.owner})}},{key:"rm",value:function(e){return this.$publish("rm",{path:e.path,owner:e.owner})}},{key:"snapshot",value:function(e){return this.$publish("snapshot",{parents:e.parents,folder:e.folder,items:e.items,flatten:e.flatten,owner:e.owner})}},{key:"stat",value:function(e){return this.$publish("stat",{path:e.path,owner:e.owner})}},{key:"updateMeta",value:function(e){return this.$publish("updateMeta",{path:e.path,metadataFiles:e.metadataFiles,metadata:e.metadata,owner:e.owner})}}],[{key:"DEFAULT_DEPLOYMENT_ID",get:function(){return"zpfs_s3compat_0"}}]),r}(),se=function(e){function r(){return t(this,r),s(this,(r.__proto__||Object.getPrototypeOf(r)).apply(this,arguments))}return o(r,u),n(r,[{key:"search",value:function(e){return this.$publish("search",{requestId:e.requestId,query:e.query,page:e.page})}},{key:"userInfo",value:function(e){return this.$publish("userInfo",{userKeys:e.userKeys})}}],[{key:"DEFAULT_DEPLOYMENT_ID",get:function(){return"userdir_0"}}]),r}(),ue=Object.freeze({Aggreg:F,Stack:N,Echo:R,Game:M,GameEngine:j,Gda:q,Remoting:H,GroupManagement:Y,Httpclient:B,MacroDebug:W,Macro:G,Sendmail:z,Messaging:Q,Queue:V,Notif:J,Rdbms:K,Sms_ovh:X,Cron:Z,Search:ee,Template:te,Trigger:ne,Zpfs_s3:re,Zpfs_hdfs:ie,Zpfs_s3compat:oe,Userdir:se}),ae=/^http:\/\/|^\/\//,ce="https://api.zpush.io/",le="undefined"!=typeof location&&"https:"===location.protocol,he=function(e){return e[Math.floor(Math.random()*e.length)]},pe=function(e,t){return t?e.replace(ae,"https://"):e},de=function(e){var t=e.sandboxId,n=e.forceHttps,r=e.transports,i=function(e){return"/"===e.charAt(e.length-1)?e:e+"/"}(pe(e.apiUrl,n));return r.fetch(""+i+t,{protocol:n?"https:":"http:"}).then(function(e){return e.json()}).then(function(e){return e.servers.map(function(e){return pe(e,n)})})},fe=function(){var e=arguments.length>1&&void 0!==arguments[1]?arguments[1]:"abcdefghijklmnopqrstuvwxyz0123456789";return Array.from(Array(arguments.length>0&&void 0!==arguments[0]?arguments[0]:7)).reduce(function(t){return""+t+e.charAt(Math.floor(Math.random()*e.length))},"")},ge={RECONNECT_HANDSHAKE_VALUE:"handshake",RECONNECT_NONE_VALUE:"none",RECONNECT_RETRY_VALUE:"retry"},ve=function(){function e(n){var r=this,i=n.apiUrl,o=n.sandboxId,s=n.forceHttps,u=void 0!==s&&s,a=n.authentication,c=n.resource,l=void 0===c?null:c,h=n.transports,p=void 0===h?A:h;t(this,e),this.sandboxId=o,this.authentication=a,this.resource=l,this.requestId=0,this.userId=null,this.userInfo=null,this.uniqId=fe(),this.servers=de({apiUrl:i,sandboxId:o,forceHttps:u,transports:p}).catch(function(e){return r.connectionToServerFail(e),[]}),this.connectionListeners=[],this.connected=!1,this.wasConnected=!1,this.serverUrl=null,this.sessionId=null,this.subscribeQueue=[],this.cometd=new U,p.ALL.forEach(function(e){r.cometd.registerTransport(e.type,new(0,e.Transport))}),this.cometd.onTransportException=function(e,t){r.updateServerUrl()},this.cometd.addListener("/meta/handshake",function(e){var t=e.ext,n=e.successful,i=e.error;if(r.cometd._debug("ClientHelper::/meta/handshake",{ext:t,successful:n,advice:e.advice,error:i}),n){var o=t.authentication;r.initialized(void 0===o?null:o)}else r.handshakeFailure(i)}),this.cometd.addListener("/meta/handshake",function(e){var t=e.advice,n=e.error,i=e.successful;if(r.cometd._debug("ClientHelper::/meta/handshake",{ext:e.ext,successful:i,advice:t,error:n}),!i){if(void 0===t)return;ge.RECONNECT_NONE_VALUE===t.reconnect?r.authenticationFailed(n):ge.RECONNECT_HANDSHAKE_VALUE===t.reconnect&&r.negotiationFailed(n)}}),this.cometd.addListener("/meta/connect",function(e){var t=e.successful;r.cometd._debug("ClientHelper::/meta/connect",{advice:e.advice,channel:e.channel,successful:t}),r.cometd.isDisconnected()?(r.connected=!1,r.connectionWillClose()):(r.wasConnected=r.connected,r.connected=t,!r.wasConnected&&r.connected?(r.cometd.batch(r,function(){r.subscribeQueue.forEach(function(e){r.subscribe(e.prefix,e.listener,e.subscriptions)})}),r.connectionEstablished()):r.wasConnected&&!r.connected&&r.connectionBroken())}),this.cometd.addListener("/meta/disconnect",function(e){r.cometd._debug("ClientHelper::/meta/disconnect",{channel:e.channel,successful:e.successful}),r.cometd.isDisconnected()&&(r.connected=!1,r.connectionClosed())})}return n(e,[{key:"addConnectionStatusListener",value:function(e){return this.connectionListeners.push({enabled:!0,listener:Object.assign(new m,e)}),this.connectionListeners.length-1}},{key:"authenticationFailed",value:function(e){this.userId=null,this.userInfo=null,this.connectionListeners.filter(function(e){return e.enabled}).forEach(function(t){t.listener.onFailedHandshake(e)})}},{key:"connect",value:function(){var e=this;this.servers.then(function(t){t.length>0?(e.serverUrl=he(t),e.cometd.configure({url:e.serverUrl+"/strd",backoffIncrement:1e3,maxBackoff:6e4,appendMessageTypeToURL:!1}),e.cometd.handshake(e.getHandshakeFields())):e.noServerUrlAvailable()})}},{key:"connectionBroken",value:function(){this.connectionListeners.filter(function(e){return e.enabled}).forEach(function(e){e.listener.onConnectionBroken()})}},{key:"connectionClosed",value:function(){this.userId=null,this.userInfo=null,this.connectionListeners.filter(function(e){return e.enabled}).forEach(function(e){e.listener.onConnectionClosed()})}},{key:"connectionEstablished",value:function(){this.connectionListeners.filter(function(e){return e.enabled}).forEach(function(e){e.listener.onConnectionEstablished()})}},{key:"connectionToServerFail",value:function(e){this.connectionListeners.filter(function(e){return e.enabled}).forEach(function(t){t.listener.onConnectionToServerFail(e)})}},{key:"connectionWillClose",value:function(){this.connectionListeners.filter(function(e){return e.enabled}).forEach(function(e){e.listener.onConnectionWillClose()})}},{key:"createAsyncMacroService",value:function(e){var t=e.listener,n=e.Type,r=e.deploymentId,i=void 0===r?n.DEFAULT_DEPLOYMENT_ID:r,o="/service/"+this.getSandboxId()+"/"+i,s=this.getAsyncMacroPublisher(o);return this.createServiceByPublisher({listener:t,prefix:o,Type:n,$publish:s})}},{key:"createAsyncTaskService",value:function(e){var t=e.Type,n=e.deploymentId,r=void 0===n?t.DEFAULT_DEPLOYMENT_ID:n,i="/service/"+this.getSandboxId()+"/"+r,o=this.getAsyncTaskPublisher(i);return this.createServiceByPublisher({listener:{},prefix:i,Type:t,$publish:o})}},{key:"createService",value:function(e){var t=e.listener,n=e.Type,r=e.deploymentId,i=void 0===r?n.DEFAULT_DEPLOYMENT_ID:r,o=function(e,t){for(var n=Object.getPrototypeOf(e),r=!1;!r&&null!==n;)r=n===t,n=Object.getPrototypeOf(n);return r}(n,G),s="/service/"+this.getSandboxId()+"/"+i,u=o?this.getMacroPublisher(s):this.getServicePublisher(s);return this.createServiceByPublisher({listener:t,prefix:s,Type:n,$publish:u})}},{key:"createServiceByPublisher",value:function(e){var t=e.listener,n=e.prefix,r=new(0,e.Type)({$publish:e.$publish});return r.$subscriptions=this.subscribe(n,t),r}},{key:"disconnect",value:function(){this.cometd.disconnect(!0)}},{key:"getAsyncMacroPublisher",value:function(e){var t=this;return function(n,i){var o=arguments.length>2&&void 0!==arguments[2]&&arguments[2],s=arguments.length>3&&void 0!==arguments[3]?arguments[3]:1,u=e+"/call",a=t.getUniqRequestId(),c={};return new Promise(function(l,h){var p,d=function(e){var n=e.data,r=void 0===n?{}:n,i=r.result,o=void 0===i?{}:i,s=r.errors,u=void 0===s?[]:s;r.requestId===a&&(u.length>0?h(u):l(o),t.unsubscribe(c))},f=(r(p={},n,d),r(p,"completed",d),p);t.subscribe(e,f,c),t.publish(u,{debug:s,hardFail:o,name:n,parameters:i,requestId:a})})}}},{key:"getAsyncTaskPublisher",value:function(e){var t=this;return function(n){var i=arguments.length>1&&void 0!==arguments[1]?arguments[1]:"",o=arguments.length>2&&void 0!==arguments[2]?arguments[2]:null,s=e+"/call",u=t.getUniqRequestId(),a={};return new Promise(function(c,l){var h=r({},"call",function(e){var n=e.data,r=void 0===n?{}:n,i=r.result,o=void 0===i?{}:i;r.requestId===u&&(r.success?c(o):l(o),t.unsubscribe(a))});t.subscribe(e,h,a),t.publish(s,{data:{name:n,namespace:i,parameters:o},requestId:u})})}}},{key:"getClientId",value:function(){return this.cometd.getClientId()}},{key:"getHandshakeFields",value:function(){return this.authentication().getHandshakeFields(this)}},{key:"getMacroPublisher",value:function(e){var t=this;return function(n,r){var i=arguments.length>2&&void 0!==arguments[2]&&arguments[2],o=arguments.length>3&&void 0!==arguments[3]?arguments[3]:1,s=e+"/call",u=t.getUniqRequestId();return t.publish(s,{debug:o,hardFail:i,name:n,parameters:r,requestId:u})}}},{key:"getQueuedSubscription",value:function(){var e=arguments.length>0&&void 0!==arguments[0]?arguments[0]:{},t=this.subscribeQueue.findIndex(function(t){return e===t.subscriptions});return{index:t,queued:t>-1}}},{key:"getResource",value:function(){return this.resource}},{key:"getSandboxId",value:function(){return this.sandboxId}},{key:"getServers",value:function(){return this.servers}},{key:"getServicePublisher",value:function(e){var t=this;return function(n,r){return t.publish(e+"/"+n,r)}}},{key:"getUniqRequestId",value:function(){return this.getClientId()+":"+this.uniqId+":"+ ++this.requestId}},{key:"getUserId",value:function(){return this.userId}},{key:"getUserInfo",value:function(){return this.userInfo}},{key:"handshakeFailure",value:function(){this.userId=null,this.userInfo=null}},{key:"initialized",value:function(e){e&&(this.userId=e.userId,this.userInfo=e.userInfo),this.connectionListeners.filter(function(e){return e.enabled}).forEach(function(t){t.listener.onSuccessfulHandshake(e)})}},{key:"isConnected",value:function(){return!this.cometd.isDisconnected()}},{key:"messageLost",value:function(e,t){this.connectionListeners.filter(function(e){return e.enabled}).forEach(function(n){n.listener.onMessageLost(e,t)})}},{key:"negotiationFailed",value:function(e){this.connectionListeners.filter(function(e){return e.enabled}).forEach(function(t){t.listener.onNegotiationFailed(e)})}},{key:"noServerUrlAvailable",value:function(){this.connectionListeners.filter(function(e){return e.enabled}).forEach(function(e){e.listener.onNoServerUrlAvailable()})}},{key:"publish",value:function(e){var t=arguments.length>1&&void 0!==arguments[1]?arguments[1]:{};return this.cometd.publish(e,t),{channel:e,parameters:t}}},{key:"removeConnectionStatusListener",value:function(e){var t=this.connectionListeners[e];t&&(t.enabled=!1)}},{key:"setAuthentication",value:function(e){this.authentication=e}},{key:"setLogLevel",value:function(e){this.cometd.setLogLevel(e)}},{key:"subscribe",value:function(e){var t=arguments.length>1&&void 0!==arguments[1]?arguments[1]:{},n=arguments.length>2&&void 0!==arguments[2]?arguments[2]:{};if(this.getQueuedSubscription(n).queued||this.subscribeQueue.push({prefix:e,listener:t,subscriptions:n}),!this.cometd.isDisconnected())for(var r in t){if(t.hasOwnProperty(r))if(void 0===n[r])n[r]=this.cometd.subscribe(e+"/"+r,t[r])}return n}},{key:"updateServerUrl",value:function(){var e=this;this.servers.then(function(t){var n=t.indexOf(e.serverUrl);n>-1&&t.splice(n,1),0===t.length?e.noServerUrlAvailable():(e.serverUrl=he(t),e.cometd.configure({url:e.serverUrl+"/strd"}),setTimeout(function(){e.cometd.handshake(e.getHandshakeFields())},250))})}},{key:"unsubscribe",value:function(){var e=arguments.length>0&&void 0!==arguments[0]?arguments[0]:{};for(var t in e){if(e.hasOwnProperty(t))this.cometd.unsubscribe(e[t])}var n=this.getQueuedSubscription(e);n.queued&&this.subscribeQueue.splice(n.index,1)}}]),e}(),ye=function(){function e(n){var r=n.apiUrl,i=void 0===r?ce:r,o=n.sandboxId,s=n.forceHttps,u=void 0===s?le:s,a=n.authentication,c=n.resource,l=n.transports;t(this,e),this.helper=new ve({apiUrl:i,sandboxId:o,forceHttps:u,authentication:a,resource:c,transports:l})}return n(e,[{key:"addConnectionStatusListener",value:function(e){return this.helper.addConnectionStatusListener(e)}},{key:"connect",value:function(){var e=this;if(this.isConnected()){var t=this.addConnectionStatusListener({onConnectionClosed:function(){e.removeConnectionStatusListener(t),e.helper.connect()}});this.disconnect()}else this.helper.connect()}},{key:"createAsyncMacroService",value:function(e){return this.helper.createAsyncMacroService({deploymentId:e.deploymentId,listener:e.listener,Type:e.Type})}},{key:"createAsyncTaskService",value:function(e){return this.helper.createAsyncTaskService({deploymentId:e.deploymentId,Type:e.Type})}},{key:"createService",value:function(e){return this.helper.createService({deploymentId:e.deploymentId,listener:e.listener,Type:e.Type})}},{key:"disconnect",value:function(){this.isConnected()&&this.helper.disconnect()}},{key:"isConnected",value:function(){return this.helper.isConnected()}},{key:"getSandboxId",value:function(){return this.helper.getSandboxId()}},{key:"getResource",value:function(){return this.helper.getResource()}},{key:"getServers",value:function(){return this.helper.getServers()}},{key:"getUserId",value:function(){return this.helper.getUserId()}},{key:"getUserInfo",value:function(){return this.helper.getUserInfo()}},{key:"removeConnectionStatusListener",value:function(e){return this.helper.removeConnectionStatusListener(e)}},{key:"setAuthentication",value:function(e){this.helper.setAuthentication(e)}},{key:"setLogLevel",value:function(e){this.helper.setLogLevel(e)}},{key:"setResource",value:function(e){this.helper.setResource(e)}},{key:"unsubscribe",value:function(e){if(!e.$subscriptions)throw new TypeError("Missing $subscriptions property in service");return this.helper.unsubscribe(e.$subscriptions)}}]),e}();Object.getOwnPropertyNames(m.prototype).forEach(function(e){ye.prototype.hasOwnProperty(e)||(ye.prototype[e]=function(t){return this.addConnectionStatusListener(r({},e,t))})});var be=function(){function e(){t(this,e),this._map=new Map}return n(e,[{key:"getItem",value:function(e){return this._map.get(e)}},{key:"setItem",value:function(e,t){return this._map.get(e)}},{key:"removeItem",value:function(e){this._map.delete(e)}},{key:"clear",value:function(){this._map=new Map}},{key:"key",value:function(e){return Array.from(this._map.keys())[e]}},{key:"length",get:function(){return this._map.size}}]),e}(),me="undefined"==typeof localStorage?new be:localStorage,ke="zetapush.token",_e=function(){function e(){var n=arguments.length>0&&void 0!==arguments[0]?arguments[0]:{},r=n.sandboxId,i=n.storage,o=void 0===i?me:i;t(this,e),this.key=ke+"."+r,this.storage=o}return n(e,[{key:"get",value:function(){var e=this.storage.getItem(this.key)||"{}",t={};try{t=JSON.parse(e)}catch(e){}return t}},{key:"set",value:function(){var e=arguments.length>0&&void 0!==arguments[0]?arguments[0]:{},t=this.key,n=this.storage,r=JSON.stringify(e);try{n.setItem(t,r)}catch(e){}return e}}]),e}(),we=function(e){function r(e){var n=e.apiUrl,i=e.deployment,o=e.sandboxId,u=e.forceHttps,a=e.resource,c=e.transports;t(this,r);var l=new _e({sandboxId:o}),h=s(this,(r.__proto__||Object.getPrototypeOf(r)).call(this,{apiUrl:n,sandboxId:o,authentication:function(){var e=l.get(),t=e.token;if(h.hasCredentials()){var n=h.getCredentials(),r=n.login,o=n.password;return h.setCredentials({}),b.simple({login:r,password:o,deploymentId:i&&i.simple})}return h.isStronglyAuthenticated(e)?b.simple({login:t,password:null,deploymentId:i&&i.simple}):b.weak({token:t,deploymentId:i&&i.weak})},forceHttps:u,resource:a,transports:c}));return h.persistence=l,h.credentials={},h.lifeCycleConnectionHandler=h.addConnectionStatusListener({onConnectionClosed:function(){l.set({})},onSuccessfulHandshake:function(e){e.token&&l.set(e)}}),h}return o(r,ye),n(r,[{key:"disconnect",value:function(){i(r.prototype.__proto__||Object.getPrototypeOf(r.prototype),"disconnect",this).call(this)}},{key:"getCredentials",value:function(){return this.credentials}},{key:"getSession",value:function(){return this.persistence.get()}},{key:"hasCredentials",value:function(){var e=this.getCredentials();return e.login&&e.password}},{key:"isStronglyAuthenticated",value:function(){var e=arguments.length>0&&void 0!==arguments[0]?arguments[0]:this.persistence.get();return!this.isWeaklyAuthenticated(e)&&"string"==typeof e.token}},{key:"isWeaklyAuthenticated",value:function(){return"string"==typeof(arguments.length>0&&void 0!==arguments[0]?arguments[0]:this.persistence.get()).publicToken}},{key:"setCredentials",value:function(e){this.credentials={login:e.login,password:e.password}}}]),r}(),Te=function(e){function r(e){var n=e.apiUrl,i=e.sandboxId,o=e.deploymentId,u=e.forceHttps,a=e.resource,c=e.transports;t(this,r);var l=s(this,(r.__proto__||Object.getPrototypeOf(r)).call(this,{apiUrl:n,sandboxId:i,forceHttps:u,authentication:function(){var e=l.getToken();return b.weak({deploymentId:o,token:e})},resource:a,transports:c}));return l.addConnectionStatusListener({onSuccessfulHandshake:function(e){var t=e.token;t&&l.strategy.set({publicToken:e.publicToken,userId:e.userId,token:t})}}),l.strategy=new _e({sandboxId:i}),l}return o(r,ye),n(r,[{key:"getToken",value:function(){return this.strategy.get().token}}]),r}(),Ie=function(e){function r(e){var n=e.apiUrl,i=e.sandboxId,o=e.forceHttps,u=e.transports,a=e.login,c=e.password;t(this,r);var l=fe();return s(this,(r.__proto__||Object.getPrototypeOf(r)).call(this,{apiUrl:n,sandboxId:i,forceHttps:o,authentication:function(){return b.developer({login:a,password:c})},resource:l,transports:u}))}return o(r,ye),n(r,[{key:"disconnect",value:function(){var e=this;return new Promise(function(t,n){var o=[];if(e.isConnected()){o.push(e.onConnectionClosed(function(){o.forEach(function(t){e.removeConnectionStatusListener(t)}),t()})),i(r.prototype.__proto__||Object.getPrototypeOf(r.prototype),"disconnect",e).call(e)}else t()})}},{key:"connect",value:function(){var e=this;return new Promise(function(t,n){var o=[];e.disconnect().then(function(){o.push(e.onConnectionEstablished(function(){o.forEach(function(t){e.removeConnectionStatusListener(t)}),t()})),o.push(e.onFailedHandshake(function(t){o.forEach(function(t){e.removeConnectionStatusListener(t)}),i(r.prototype.__proto__||Object.getPrototypeOf(r.prototype),"connect",e).call(e),n(t)})),i(r.prototype.__proto__||Object.getPrototypeOf(r.prototype),"connect",e).call(e)})})}},{key:"subscribeTaskServer",value:function(e){var t=arguments.length>1&&void 0!==arguments[1]?arguments[1]:V.DEFAULT_DEPLOYMENT_ID;console.log("subscribeTaskServer",e,t);var n=this.createService({deploymentId:t,listener:{dispatch:function(){var t,r=(t=regeneratorRuntime.mark(function t(r){var i,o,s,u,a,c=r.data,l=c.request,h=c.taskId;return regeneratorRuntime.wrap(function(t){for(;;)switch(t.prev=t.next){case 0:return console.log("dispatch",{request:l,taskId:h}),console.log("Queue::dispatch",{name:s=(i=l.data).name,namespace:i.namespace,parameters:u=i.parameters,requestId:o=l.requestId,taskId:h}),t.prev=4,t.next=7,e[s](u);case 7:console.log("result",a=t.sent),n.done({result:a,taskId:h,requestId:o,success:!0}),t.next=16;break;case 12:t.prev=12,t.t0=t.catch(4),console.log("error",t.t0),n.done({result:{code:"",message:""},taskId:h,requestId:o,success:!1});case 16:case"end":return t.stop()}},t,this,[[4,12]])}),function(){var e=t.apply(this,arguments);return new Promise(function(t,n){return function r(i,o){try{var s=e[i](o),u=s.value}catch(e){return void n(e)}if(!s.done)return Promise.resolve(u).then(function(e){r("next",e)},function(e){r("throw",e)});t(u)}("next")})});return function(e){return r.apply(this,arguments)}}()},Type:V});n.register({capacity:100})}}]),r}();e.VERSION="3.4.0-alpha.2",e.Authentication=b,e.ConnectionStatusListener=m,e.Client=ye,e.SmartClient=we,e.WeakClient=Te,e.ServerClient=Ie,e.services=ue,Object.defineProperty(e,"__esModule",{value:!0})});
//# sourceMappingURL=zetapush.min.js.map
